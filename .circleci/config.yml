version: 2.1
orbs:
  cypress: cypress-io/cypress@1.13.0
jobs:
  build:
    # pre-built images: https://circleci.com/docs/2.0/circleci-images/
    docker:
      - image: circleci/node:10-browsers
    steps:
      - checkout
      - run:
          name: Installing
          command: npm ci
      - run:
          name: Creating build
          command: npm run build
      - persist_to_workspace:
          # Must be an absolute path, or relative path from working_directory. This is a directory on the container which is
          # taken to be the root directory of the workspace.
          root: .
          paths:
            - dist
  test:
    docker:
      - image: circleci/node:10-browsers
    steps:
      - checkout
      - run:
          name: Installing
          command: npm ci CYPRESS_INSTALL_BINARY=0
      - run:
          name: Running Test suite
          command: npm run test
  deployment:
    machine:
      image: default
    steps:
      - add_ssh_keys:
          fingerprints:
            - "7e:c4:71:44:9c:c5:20:73:40:75:3f:c7:e6:74:ad:54"
      - attach_workspace:
          at: .
      - run:
          name: Deploy Over SSH
          command: |
            ls -la
            rsync -a -e 'ssh -p 18765' ./dist/ $SSH_USER@$SSH_HOST:www/sketches.lukecochrane.ca/public_html
workflows:
  build-test-and-deploy:
      jobs:
        - build
        - test:
            requires:
              - build
        - cypress/run:
            start: npm run start
            wait-on: 'http://127.0.0.1:8080'
            requires:
              - build
            filters:
              branches:
                only:
                  - master
                  - staging
                  - production
        - deployment:
            requires:
              - test
              - cypress/run
            filters:
              branches:
                only:
                  - staging
                  - production